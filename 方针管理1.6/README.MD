# 方针管理KPI日经营看板系统

## 项目说明
这是一个全员使用的KPI可视化管理系统，通过实时同步Excel数据，提供符合方针管理标准的日经营看板展示。

## 功能特性
- Excel文件实时监控和自动同步
- 卡片式KPI看板展示
- 多维度数据可视化（趋势图、对比图、进度条）
- 按时间组织的历史数据查看
- 数据提醒功能（未提交、未达标、异常检测）
- 响应式设计，支持PC和移动端

---

## 一、系统部署

### 1. 环境要求
- **Node.js**: 版本 14.0 或更高
- **操作系统**: Windows/Mac/Linux
- **浏览器**: Chrome/Edge/Firefox/Safari

### 2. 部署步骤

#### 步骤1：安装Node.js
1. 访问 https://nodejs.org/
2. 下载并安装LTS版本
3. 验证安装：打开命令行输入 `node -v`

#### 步骤2：复制项目文件
将整个 `方针管理` 文件夹复制到目标电脑，例如：
- Windows: `C:\方针管理\` 或 `D:\Projects\方针管理\`
- Mac/Linux: `~/方针管理/`

#### 步骤3：安装依赖
打开命令行，进入项目目录，执行：

```bash
cd "C:\方针管理"
npm install
```

#### 步骤4：启动服务
```bash
npm start
```

看到以下信息表示启动成功：
```
=================================
方针管理KPI日经营看板系统
=================================
服务器运行在: http://localhost:3000
Excel监控目录: C:\方针管理\mock_data
=================================
```

#### 步骤5：访问系统
打开浏览器访问：**http://localhost:3000**

#### 步骤6：局域网内其他电脑访问
1. 在服务器电脑上打开命令行输入 `ipconfig`，找到 IPv4 地址（如：192.168.1.100）
2. 其他电脑访问：`http://192.168.1.100:3000`
3. 确保服务器电脑防火墙允许 3000 端口访问

#### 步骤7：首次初始化（推荐）
首次部署建议先执行初始化脚本：

```bash
npm run init-data
```

然后再启动服务：

```bash
npm start
```

---

## 二、数据管理（Excel文件规范）

### 1. 文件存放位置
将Excel文件放在 `mock_data` 文件夹下，按日期组织：
```
mock_data/
└── 2026/
    └── 01/
        └── 16/
            ├── 人事部-人事专员-张三.xlsx
            ├── 生产部-操作工-李四.xlsx
            └── ...
```

### 2. 文件命名格式
```
部门-岗位-姓名.xlsx
```
示例：
- `人事部-人事专员-张三.xlsx`
- `生产部-操作工-李四.xlsx`
- `销售部-销售代表-王五.xlsx`

### 3. Excel表格格式要求

Excel中必须包含包含"KPI名称"的表头行，支持以下列名：


示例表格：
```
KPI名称      | 目标值 | 实际值 | 单位 | 备注
招聘完成率   | 100    | 95     | %    |
培训课时     | 10     | 8      | 小时 |
```

### 4. 数据自动同步
- Excel文件保存后，系统会在30秒内自动检测并同步数据
- 无需重启服务

---

## 三、系统使用说明

### 1. 主界面功能

| 功能区域 | 说明 |
|---|---|
| 顶部导航 | 显示系统名称、提醒通知、刷新按钮 |
| 筛选栏 | 按日期、部门、人员、关键词筛选数据 |
| 视图切换 | 日看板、卡片视图、图表视图、统计概览 |

### 2. 四种视图模式
#### 日看板
- 展示个人的KPID达成看板

#### 卡片视图（默认）
- 展示每个KPI的详细卡片
- 显示目标值、实际值、完成率、进度条
- 点击卡片查看详情和趋势图

#### 图表视图
- 查看KPI的历史趋势
- 可切换人员、KPI、图表类型
- 支持趋势图、对比图、进度图

#### 统计概览
- 整体完成情况统计
- 部门、人员数量统计
- 达标率分析

### 3. 筛选功能
- **日期筛选**: 选择查看哪一天的数据
- **部门筛选**: 查看特定部门
- **人员筛选**: 查看特定人员
- **搜索**: 按KPI名称搜索

### 4. 提醒功能
- 点击右上角铃铛图标查看提醒
- 提醒类型：未提交、未达标、异常数据

### 5. 移动端使用

#### 5.1 同一WiFi下访问
手机和电脑连接同一WiFi后，可通过以下方式访问：

**步骤1：获取服务器IP地址**
- Windows：打开命令行输入 `ipconfig`，查找"IPv4 地址"（如：192.168.1.100）
- Mac：打开终端输入 `ifconfig`，查找"inet "地址

**步骤2：手机浏览器访问**
在手机浏览器中输入：`http://服务器IP地址:3000`

例如：`http://192.168.1.100:3000`

**注意事项：**
- 确保手机和电脑在同一WiFi网络
- 确保电脑防火墙允许3000端口访问
- 如无法访问，检查Windows防火墙或杀毒软件设置

#### 5.2 导出数据到微信查看

系统支持导出当天数据为独立HTML文件，可通过微信发送和查看：

**导出步骤：**
1. 在网页上选择要导出的日期
2. 点击顶部"📱 导出移动版"按钮
3. 浏览器会自动下载一个HTML文件（如：`KPI看板_2026-01-17_2026-01-17.html`）

**发送到微信：**
1. 打开微信电脑版
2. 将下载的HTML文件拖拽到微信聊天窗口发送
3. 或在手机微信中点击文件即可查看

**导出文件的筛选功能：**
导出的HTML文件支持在手机端进行筛选：
- 📅 **日期筛选**：选择不同日期的数据
- 🏢 **部门筛选**：选择特定部门
- 👤 **人员筛选**：选择特定人员（选择部门后会自动更新人员列表）
- 🔍 **搜索功能**：搜索KPI名称

**重要说明：**
- 导出功能只包含当前选择日期的完整数据
- 导出的文件是独立的HTML文件，无需网络即可打开
- 所有筛选功能在手机端本地完成，无需服务器支持

---

## 四、常见问题

### Q1: 端口3000被占用怎么办？
修改 `server.js` 中的端口号：
```javascript
const PORT = process.env.PORT || 3001; // 改为其他端口
```

### Q2: 如何让局域网其他电脑访问？
1. 查看服务器IP地址（如：192.168.1.100）
2. 其他电脑访问：`http://192.168.1.100:3000`

### Q3: 数据没有自动刷新？
点击右上角"刷新"按钮，或等待30秒自动刷新

### Q4: 如何备份数据？
数据库文件位于 `database/kpi.db`，复制此文件即可备份

### Q5: 如何添加新部门？
在 `mock_data` 下创建对应的Excel文件，文件命名格式：`部门-岗位-姓名.xlsx`，保存后系统会自动同步

### Q6: 手机访问显示"无法连接"怎么办？
1. 确认手机和电脑在同一WiFi
2. 确认服务器正在运行（电脑上访问 http://localhost:3000 能正常打开）
3. Windows防火墙可能阻止了连接，需要允许Node.js通过防火墙
4. 尝试临时关闭防火墙测试是否能连接

### Q7: 导出的HTML文件在微信中打不开？
1. 确认导出的文件大小不超过微信限制（通常200MB）
2. 部分手机浏览器对本地HTML文件支持有限，建议使用Chrome或Edge浏览器打开
3. 如果仍然无法打开，可以通过手机连接同一WiFi直接访问服务器

### Q8: 导出的数据是否包含所有日期？
导出功能只包含当前选择日期的完整数据。如需其他日期的数据，请选择对应日期后重新导出。

---

## 五、开发相关

### 目录结构
```
方针管理/
├── server.js              # 主服务器文件
├── package.json           # 项目配置
├── database/              # 数据库目录
│   ├── db.js             # 数据库连接
│   └── schema.sql        # 数据库结构
├── services/              # 业务逻辑
│   ├── excelWatcher.js   # Excel文件监控
│   ├── excelParser.js    # Excel解析
│   ├── alertService.js   # 提醒服务
│   └── authService.js    # 认证服务
├── routes/                # API路由
│   └── api.js            # API接口
├── public/                # 前端文件
│   ├── index.html        # 主页面
│   ├── css/
│   │   └── style.css     # 样式
│   └── js/
│       ├── app.js        # 主应用
│       └── charts.js     # 图表组件
├── scripts/               # 脚本
│   └── initData.js       # 数据初始化
└── mock_data/             # Excel文件存储
```

### 技术栈
- 后端：Node.js + Express
- 数据库：SQLite
- 前端：原生HTML/CSS/JavaScript
- 图表：Chart.js
- Excel处理：xlsx
- 文件监控：chokidar

### 配置说明

#### Excel文件路径
在 `server.js` 中配置Excel文件监控路径：
```javascript
const EXCEL_DIR = path.join(__dirname, 'mock_data');
```

#### 数据库
使用SQLite数据库，数据库文件位于 `database/kpi.db`

#### 数据更新频率
Excel文件修改后30秒内自动同步到系统

---

## 六、KPI方向分类说明

### 正向指标 vs 反向指标

系统会自动判断每个KPI是**正向指标**（越高越好）还是**反向指标**（越低越好），并在趋势图中正确显示红黄绿背景区域：

- **正向指标**：产量、销量、销售额、合格率等（数值越高越好）
- **反向指标**：成本、费用、缺陷率、投诉率等（数值越低越好）

### 自动分类规则

系统通过KPI名称中的关键词自动分类：

**反向指标关键词**（越低越好）：
- 成本、费用、消耗、损耗
- 不合格率、缺陷率、报废率、不良率、投诉率、故障率
- 退货率、拒收率、差错率、失误率
- 库存天数、周转天数、停机时间

**正向指标关键词**（越高越好）：
- 产量、销量、销售额、收入、利润
- 合格率、达成率、完成率、通过率
- 准时率、及时率、响应率
- 满意度、好评率、推荐率
- 稼动率、利用率、效率、效能

### 如何修改分类规则

如果需要添加或修改分类规则，只需编辑 `services/excelSyncService.js` 中的 `classifyKpiDirection` 函数，修改关键词列表即可。

**步骤：**

1. 打开文件：`services/excelSyncService.js`
2. 找到 `classifyKpiDirection` 函数（约第206行）
3. 在关键词数组中添加或删除关键词

**示例**：添加新的反向指标关键词

```javascript
// 在 services/excelSyncService.js 中找到 classifyKpiDirection 函数

classifyKpiDirection(kpiName) {
    const reverseKeywords = [
        '成本', '费用', '消耗', '损耗',
        '不合格率', '缺陷率', '报废率', '不良率', '投诉率', '故障率',
        '退货率', '拒收率', '差错率', '失误率',
        '库存天数', '周转天数', '停机时间',
        // 在这里添加新的反向关键词，例如：
        '能耗', '废品率', '返工率'
    ];

    const forwardKeywords = [
        '产量', '销量', '销售额', '收入', '利润',
        '合格率', '达成率', '完成率', '通过率',
        '准时率', '及时率', '响应率',
        '满意度', '好评率', '推荐率',
        '稼动率', '利用率', '效率', '效能'
        // 在这里添加新的正向关键词
    ];

    // ... 其余代码保持不变
}
```

4. 保存文件后重启服务器：
```bash
# 停止当前服务 (Ctrl+C)
# 重新启动
npm start
```

**注意**：修改后重启服务器，新规则会立即生效。历史数据会在下次同步时自动使用新规则重新分类。

---

## 七、系统初始化操作

### 什么是系统初始化？

系统初始化是指清空数据库并重新从Excel文件同步所有数据。这通常用于：
- 修改了KPI分类规则后，需要重新对所有数据进行分类
- 数据库出现问题需要重建
- 测试或开发环境需要重置

### 初始化步骤

#### 方法零：使用初始化脚本（推荐）

```bash
# 首次部署或需要重建数据时执行
npm run init-data
```

执行后会初始化数据库结构并准备基础数据，再启动服务即可：

```bash
npm start
```

#### 方法一：手动删除数据库（推荐）

1. **停止服务器**
   在运行服务器的命令行窗口按 `Ctrl+C` 停止服务

2. **删除数据库文件**
   ```bash
   del "C:\Users\erp17\方针管理\database\kpi.db"
   ```
   或者直接在文件资源管理器中删除 `database\kpi.db` 文件

3. **重新启动服务器**
   ```bash
   cd "C:\Users\erp17\方针管理"
   npm start
   ```

4. **验证初始化**
   服务器启动后会自动创建新数据库并同步所有Excel文件，您会看到类似以下信息：
   ```
   ================================================
   方针管理KPI日经营看板系统
   ================================================
   数据库初始化完成
   Excel同步服务启动，监控路径: C:\Users\erp17\方针管理\mock_data
   已同步 XXXX 条KPI数据到数据库
   ```

#### 方法二：使用命令行脚本（一次性执行）

```bash
# 停止可能运行的Node进程（可选）
taskkill /F /IM node.exe

# 删除数据库
del "C:\Users\erp17\方针管理\database\kpi.db"

# 启动服务器
cd "C:\Users\erp17\方针管理"
npm start
```

### 注意事项

1. **数据备份**：初始化会删除所有历史数据，如需备份数据库，请先复制 `database\kpi.db` 文件
2. **不可逆操作**：数据库删除后无法恢复，请谨慎操作
3. **Excel文件**：初始化后系统会从 `mock_data` 文件夹重新读取所有Excel文件
4. **分类规则**：初始化后会使用最新的分类规则对所有KPI重新分类

### 验证初始化结果

访问 http://localhost:3000 检查：
- 首页是否正常显示数据
- 筛选栏中是否显示正确的部门和人员列表
- 卡片视图中的KPI颜色是否正确（根据正向/反向指标）
- 图表是否正常显示

